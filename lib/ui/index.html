<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Prompts Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .markdown-body { white-space: pre-wrap; font-family: monospace; }
        /* Scrollbar styles for dark mode */
        .dark ::-webkit-scrollbar { width: 10px; height: 10px; }
        .dark ::-webkit-scrollbar-track { background: #000000; }
        .dark ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 5px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons
        const SunIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        );

        const MoonIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        );

        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );

        const CheckIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        );

        function CopyButton({ text, className }) {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                const content = typeof text === 'object' ? JSON.stringify(text, null, 2) : text;
                navigator.clipboard.writeText(content);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            return (
                <button 
                    onClick={handleCopy} 
                    className={`flex items-center space-x-1 text-[9px] uppercase tracking-wider transition-colors hover:text-blue-500 focus:outline-none ${className}`}
                    title="Copy to clipboard"
                >
                    {copied ? <CheckIcon /> : <CopyIcon />}
                    <span>{copied ? 'Copied' : 'Copy'}</span>
                </button>
            );
        }

        function App() {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [workflowName, setWorkflowName] = useState('');
            const [theme, setTheme] = useState('dark');
            const [sortOrder, setSortOrder] = useState('newest'); // 'newest' | 'oldest'

            useEffect(() => {
                const fetchData = () => {
                    fetch('/api/history')
                        .then(res => res.json())
                        .then(data => {
                            setHistory(data.entries);
                            setWorkflowName(data.workflowName);
                            setLoading(false);
                        })
                        .catch(err => {
                            setError(err.message);
                            setLoading(false);
                        });
                };

                // Initial fetch
                fetchData();

                // Setup SSE
                const eventSource = new EventSource('/api/events');
                eventSource.onmessage = (event) => {
                    if (event.data === 'update') {
                        fetchData();
                    }
                };

                return () => {
                    eventSource.close();
                };
            }, []);

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            const toggleSort = () => {
                setSortOrder(prev => prev === 'newest' ? 'oldest' : 'newest');
            };

            if (loading) return (
                <div className={theme}>
                    <div className="flex items-center justify-center h-screen bg-gray-50 dark:bg-black text-gray-500 dark:text-zinc-500">
                        Loading history...
                    </div>
                </div>
            );
            
            if (error) return (
                <div className={theme}>
                    <div className="flex items-center justify-center h-screen bg-gray-50 dark:bg-black text-red-500">
                        Error: {error}
                    </div>
                </div>
            );

            // Filter for events we want to display
            let visibleEvents = history.filter(item => 
                [
                    'WORKFLOW_STARTED', 'WORKFLOW_COMPLETED', 'WORKFLOW_FAILED', 'WORKFLOW_RESET',
                    'AGENT_STARTED', 'AGENT_COMPLETED', 'AGENT_FAILED',
                    'INTERACTION_REQUESTED', 'INTERACTION_RESOLVED'
                ].includes(item.event)
            );

            // Apply Sort
            // History from API is "Newest First" (index 0 is latest)
            if (sortOrder === 'oldest') {
                visibleEvents = [...visibleEvents].reverse();
            }

            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            return (
                <div className={theme}>
                    <div className="min-h-screen bg-gray-50 dark:bg-black transition-colors duration-200">
                        <div className="max-w-5xl mx-auto min-h-screen flex flex-col">
                            
                            {/* Sticky Header */}
                            <header className="sticky top-0 z-50 py-4 px-6 bg-gray-50/90 dark:bg-black/90 backdrop-blur-md border-b border-gray-200 dark:border-zinc-800 flex items-center justify-between mb-8 transition-colors">
                                <div className="flex-1">
                                    <h1 className="text-xl font-bold text-gray-800 dark:text-zinc-100 transition-colors uppercase tracking-tight">{workflowName}</h1>
                                    <p className="text-gray-500 dark:text-zinc-500 text-xs mt-0.5">Runtime History & Prompt Logs</p>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button 
                                        onClick={toggleSort}
                                        className="p-2 rounded-full bg-gray-200 dark:bg-zinc-900 text-gray-800 dark:text-zinc-200 hover:bg-gray-300 dark:hover:bg-zinc-800 transition-colors"
                                        title={sortOrder === 'newest' ? "Sort: Newest First" : "Sort: Oldest First"}
                                    >
                                        {sortOrder === 'newest' ? 
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg> 
                                            : 
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" transform="scale(1, -1) translate(0, -24)" /></svg>
                                        }
                                    </button>
                                    <button 
                                        onClick={toggleTheme}
                                        className="p-2 rounded-full bg-gray-200 dark:bg-zinc-900 text-gray-800 dark:text-zinc-200 hover:bg-gray-300 dark:hover:bg-zinc-800 transition-colors"
                                        title="Toggle Theme"
                                    >
                                        {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
                                    </button>
                                </div>
                            </header>

                            {/* Content */}
                            <div className="flex-1 space-y-8 px-6">
                                {visibleEvents.length === 0 && (
                                    <div className="text-center text-gray-400 py-10">No execution history found.</div>
                                )}

                                {visibleEvents.map((item, idx) => {
                                    // 1. Lifecycle Events
                                    if (item.event.startsWith('WORKFLOW_')) {
                                        const colorMap = {
                                            'WORKFLOW_STARTED': 'text-green-500 dark:text-green-400',
                                            'WORKFLOW_COMPLETED': 'text-blue-500 dark:text-blue-400',
                                            'WORKFLOW_FAILED': 'text-red-500 dark:text-red-400',
                                            'WORKFLOW_RESET': 'text-yellow-500 dark:text-yellow-400'
                                        };
                                        return (
                                            <div key={idx} className="flex flex-col items-center py-4">
                                                <div className="flex items-center space-x-3 text-[10px] uppercase tracking-[0.2em] font-bold text-zinc-400 dark:text-zinc-600">
                                                    <div className="h-px w-8 bg-zinc-200 dark:bg-zinc-800"></div>
                                                    <span className={colorMap[item.event]}>{item.event.replace('_', ' ')}</span>
                                                    <span>{formatTime(item.timestamp)}</span>
                                                    <div className="h-px w-8 bg-zinc-200 dark:bg-zinc-800"></div>
                                                </div>
                                                {item.error && <div className="mt-2 text-red-500 text-xs font-mono">{item.error}</div>}
                                            </div>
                                        );
                                    }

                                    // 2. Agent Started
                                    if (item.event === 'AGENT_STARTED') {
                                        return (
                                            <div key={idx} className="flex justify-start">
                                                <div className="text-[10px] text-zinc-400 dark:text-zinc-600 uppercase tracking-widest flex items-center space-x-2">
                                                    <span className="w-1.5 h-1.5 rounded-full bg-blue-500/50 animate-pulse"></span>
                                                    <span>Agent <span className="text-zinc-600 dark:text-zinc-400">{item.agent}</span> started</span>
                                                    <span>&bull;</span>
                                                    <span>{formatTime(item.timestamp)}</span>
                                                </div>
                                            </div>
                                        );
                                    }

                                    // 3. Agent Failed
                                    if (item.event === 'AGENT_FAILED') {
                                        return (
                                            <div key={idx} className="flex justify-center">
                                                <div className="bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-900/50 rounded-lg px-4 py-2 text-red-600 dark:text-red-400 text-xs font-mono w-full max-w-2xl">
                                                    <div className="font-bold mb-1 underline">AGENT FAILED: {item.agent}</div>
                                                    <div>{item.error}</div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    // 4. Interaction Requested
                                    if (item.event === 'INTERACTION_REQUESTED') {
                                        return (
                                            <div key={idx} className="flex justify-center">
                                                <div className="bg-zinc-100 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 border-dashed rounded-lg px-6 py-4 text-center max-w-md w-full">
                                                    <div className="text-[10px] text-zinc-400 dark:text-zinc-600 uppercase font-bold tracking-widest mb-1">Human Intervention Needed</div>
                                                    <div className="text-xs text-zinc-600 dark:text-zinc-400 italic">Waiting for response to "{item.slug}"...</div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    // 5. Agent Completed / Interaction Resolved (The Bubbles)
                                    if (item.event === 'AGENT_COMPLETED' || item.event === 'INTERACTION_RESOLVED') {
                                        return (
                                            <div key={idx} className="flex flex-col space-y-4">
                                                {/* Header Line */}
                                                <div className="flex items-center justify-center space-x-2 text-[10px] text-zinc-400 dark:text-zinc-600 uppercase tracking-widest">
                                                    <span className="font-black text-zinc-500 dark:text-zinc-400">{item.agent || item.slug}</span>
                                                    <span>&bull;</span>
                                                    <span>COMPLETED</span>
                                                    <span>&bull;</span>
                                                    <span>{formatTime(item.timestamp)}</span>
                                                </div>

                                                {/* Output (Response) - NOW ON TOP */}
                                                {(item.output || item.result) && (
                                                    <div className="flex justify-end w-full group">
                                                        <div className="max-w-[85%] bg-blue-50 dark:bg-blue-950/20 border border-blue-100 dark:border-blue-900/40 rounded-2xl rounded-tr-none shadow-sm p-6 transition-all hover:border-blue-200 dark:hover:border-blue-800 relative">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <div className="text-[9px] font-black text-blue-300 dark:text-blue-800/60 uppercase tracking-[0.2em] text-right w-full">Output / Response</div>
                                                                <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <CopyButton text={item.output || item.result} className="text-blue-400 hover:text-blue-600 dark:text-blue-600 dark:hover:text-blue-400" />
                                                                </div>
                                                            </div>
                                                            <div className="markdown-body text-gray-800 dark:text-zinc-200 text-sm overflow-x-auto leading-relaxed">
                                                                {typeof item.output === 'object' ? JSON.stringify(item.output, null, 2) : (item.output || item.result)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Prompt (Input) - NOW ON BOTTOM */}
                                                {item.prompt && (
                                                    <div className="flex justify-start w-full group">
                                                        <div className="max-w-[85%] bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-2xl rounded-tl-none shadow-sm p-6 transition-all hover:border-zinc-300 dark:hover:border-zinc-700 relative">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <div className="text-[9px] font-black text-zinc-300 dark:text-zinc-700 uppercase tracking-[0.2em]">Prompt / Input</div>
                                                                <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <CopyButton text={item.prompt} className="text-gray-400 hover:text-gray-600 dark:text-zinc-600 dark:hover:text-zinc-400" />
                                                                </div>
                                                            </div>
                                                            <div className="markdown-body text-gray-800 dark:text-zinc-300 text-sm overflow-x-auto leading-relaxed">
                                                                {item.prompt}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    }

                                    return null;
                                })}
                            </div>

                            <footer className="mt-20 mb-8 text-center text-zinc-400 dark:text-zinc-800 text-[10px] uppercase tracking-[0.3em] transition-colors">
                                Agent State Machine &bull; Debug Terminal
                            </footer>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>