<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{WORKFLOW_NAME}} - Remote Follow</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: "class" };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --fg: #000000;
            --muted: rgba(0, 0, 0, 0.6);
            --hairline: rgba(0, 0, 0, 0.12);
            --hairline-strong: rgba(0, 0, 0, 0.2);
            --focus: rgba(0, 0, 0, 0.35);
            --chip: rgba(0, 0, 0, 0.06);
            --chip-strong: rgba(0, 0, 0, 0.1);
            --danger: rgba(0, 0, 0, 0.85);
            --ok: rgba(0, 0, 0, 0.85);
            --warn: rgba(0, 0, 0, 0.85);
        }

        .dark {
            --bg: #000000;
            --fg: #ffffff;
            --muted: rgba(255, 255, 255, 0.65);
            --hairline: rgba(255, 255, 255, 0.14);
            --hairline-strong: rgba(255, 255, 255, 0.22);
            --focus: rgba(255, 255, 255, 0.35);
            --chip: rgba(255, 255, 255, 0.08);
            --chip-strong: rgba(255, 255, 255, 0.14);
            --danger: rgba(255, 255, 255, 0.92);
            --ok: rgba(255, 255, 255, 0.92);
            --warn: rgba(255, 255, 255, 0.92);
        }

        html,
        body {
            height: 100%;
        }

        body {
            background: var(--bg);
            color: var(--fg);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            letter-spacing: 0.01em;
            margin: 0;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--chip-strong);
            border-radius: 999px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--hairline-strong);
        }

        .hairline {
            border: 1px solid var(--hairline);
        }

        .hairline-strong {
            border: 1px solid var(--hairline-strong);
        }

        .divider {
            border-top: 1px solid var(--hairline);
        }

        .kbd {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border: 1px solid var(--hairline);
            border-bottom-color: var(--hairline-strong);
            border-radius: 8px;
            background: transparent;
            color: var(--muted);
            font-size: 11px;
            line-height: 1;
            user-select: none;
        }

        .markdown-body {
            white-space: pre-wrap;
        }

        .agent-prompt summary {
            list-style: none;
        }

        .agent-prompt summary::-webkit-details-marker {
            display: none;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .blink {
            animation: blink 1.1s steps(2, end) infinite;
        }

        .glow-dot {
            background: var(--fg);
            box-shadow: 0 0 0 2px var(--chip), 0 0 10px var(--fg);
        }

        button,
        textarea {
            -webkit-tap-highlight-color: transparent;
        }

        button:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* === ONE COLUMN, "INPUT" LEFT / "OUTPUT" RIGHT, ALL LTR === */
        .edge-wrap {
            width: 100%;
            padding-left: 12px;
            padding-right: 12px;
        }

        @media (min-width: 640px) {
            .edge-wrap {
                padding-left: 16px;
                padding-right: 16px;
            }
        }

        .io-row {
            display: flex;
            width: 100%;
        }

        .io-left {
            justify-content: flex-start;
        }

        .io-right {
            justify-content: flex-end;
        }

        .io-center {
            justify-content: center;
        }

        .io-card {
            width: min(880px, 100%);
        }

        .io-in {
            text-align: left;
            direction: ltr;
        }

        .io-out {
            text-align: right;
            direction: ltr;
        }

        .rtl-safe {
            direction: ltr;
        }

        /* centered chrome (header/footer/empty states) */
        .center-wrap {
            width: min(880px, 100%);
            margin-left: auto;
            margin-right: auto;
        }

        /* NEW: center the “meta rows” inside their cards */
        .meta-center {
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        window.SESSION_TOKEN = "{{SESSION_TOKEN}}";
        window.WORKFLOW_NAME_TEMPLATE = "{{WORKFLOW_NAME}}";
    </script>

    <script type="text/babel">
        const { useEffect, useMemo, useState } = React;

        const Icon = ({ name }) => {
            const common = "w-4 h-4";
            if (name === "sun") {
                return (
                    <svg className={common} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" d="M12 3v2M12 19v2M4 12H2M22 12h-2M5.6 5.6l1.4 1.4M17 17l1.4 1.4M18.4 5.6 17 7M7 17l-1.4 1.4" />
                        <circle cx="12" cy="12" r="4" />
                    </svg>
                );
            }
            if (name === "moon") {
                return (
                    <svg className={common} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M21 13.2A8.5 8.5 0 0 1 10.8 3 7.5 7.5 0 1 0 21 13.2z" />
                    </svg>
                );
            }
            if (name === "copy") {
                return (
                    <svg className={common} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" />
                        <path strokeLinecap="round" d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                    </svg>
                );
            }
            if (name === "check") {
                return (
                    <svg className={common} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M20 6 9 17l-5-5" />
                    </svg>
                );
            }
            return null;
        };

        function StatusBadge({ status }) {
            const labels = { connected: "Live", disconnected: "Offline", connecting: "Connecting..." };
            const dotClass =
                status === "connecting" ? "blink" : status === "connected" ? "blink glow-dot" : "";
            return (
                <div className="flex items-center gap-2">
                    <div className={`w-2 h-2 rounded-full ${dotClass}`} />
                    <span className="text-[10px] uppercase tracking-wider font-bold" style={{ color: "var(--muted)" }}>
                        {labels[status] || status}
                    </span>
                </div>
            );
        }

        function CopyButton({ text, className = "" }) {
            const [copied, setCopied] = useState(false);
            const handleCopy = async () => {
                const content = typeof text === "object" ? JSON.stringify(text, null, 2) : String(text);
                try {
                    await navigator.clipboard.writeText(content);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 1500);
                } catch (e) {
                    const ta = document.createElement("textarea");
                    ta.value = content;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand("copy");
                    document.body.removeChild(ta);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 1500);
                }
            };
            return (
                <button
                    onClick={handleCopy}
                    className={`inline-flex items-center gap-2 px-3 py-2 rounded-xl hairline hover:hairline-strong transition ${className}`}
                    title="Copy"
                    type="button"
                    style={{ color: "var(--fg)", background: "transparent" }}
                >
                    {copied ? <Icon name="check" /> : <Icon name="copy" />}
                    <span className="text-[11px] tracking-[0.14em] font-semibold">{copied ? "COPIED" : "COPY"}</span>
                </button>
            );
        }

        function Toggle({ onClick, label, title, children }) {
            return (
                <button
                    onClick={onClick}
                    className="inline-flex items-center gap-2 px-3 py-2 rounded-xl hairline hover:hairline-strong transition"
                    title={title}
                    type="button"
                    style={{ background: "transparent", color: "var(--fg)" }}
                >
                    {children}
                    <span className="text-[11px] tracking-[0.14em] font-semibold">{label}</span>
                </button>
            );
        }

        function JsonView({ data, label, onTop = false, timestamp, align = "left" }) {
            const [viewMode, setViewMode] = useState("clean"); // clean | raw
            const isObject = typeof data === "object" && data !== null;
            const rawContent = isObject ? JSON.stringify(data, null, 2) : String(data);
            const hasToggle = isObject || rawContent.includes("\\n");

            const cleanParts = useMemo(() => {
                if (!isObject) return null;
                const keys = Object.keys(data || {});
                if (!keys.length) return null;
                return keys.map((k) => {
                    const val = data[k];
                    const renderedVal = typeof val === "string" ? val : JSON.stringify(val, null, 2);
                    return (
                        <div key={k} className="py-4">
                            <div className="text-[11px] tracking-[0.18em] font-semibold mb-2" style={{ color: "var(--muted)" }}>
                                {k.toUpperCase()}
                            </div>
                            <div className="markdown-body text-[13px] leading-relaxed">{String(renderedVal)}</div>
                        </div>
                    );
                });
            }, [data, isObject]);

            const ioClass = align === "right" ? "io-out" : "io-in";

            return (
                <div className={`hairline rounded-2xl ${onTop ? "rounded-tr-none" : ""} overflow-hidden ${ioClass}`} style={{ background: "transparent" }}>
                    <div className="rtl-safe flex items-center justify-between px-5 py-4 divider">
                        <div className="flex items-center gap-3 min-w-0">
                            <div className="text-[11px] tracking-[0.22em] font-semibold truncate" style={{ color: "var(--muted)" }}>
                                {label}
                            </div>
                            {timestamp && (
                                <span className="text-[11px] tracking-[0.12em]" style={{ color: "var(--muted)" }}>
                                    {timestamp}
                                </span>
                            )}
                        </div>

                        <div className="flex items-center gap-2">
                            {hasToggle && (
                                <button
                                    onClick={() => setViewMode((v) => (v === "clean" ? "raw" : "clean"))}
                                    className="px-3 py-2 rounded-xl hairline hover:hairline-strong transition"
                                    type="button"
                                    title={viewMode === "clean" ? "Switch to raw" : "Switch to clean"}
                                    style={{ background: "transparent", color: "var(--fg)" }}
                                >
                                    <span className="text-[11px] tracking-[0.14em] font-semibold">
                                        {viewMode === "clean" ? "RAW" : "CLEAN"}
                                    </span>
                                </button>
                            )}
                            <CopyButton text={data} />
                        </div>
                    </div>

                    <div className="px-5 py-4">
                        <div className="markdown-body text-[13px] leading-relaxed overflow-x-auto">
                            {viewMode === "clean" ? (cleanParts ?? rawContent) : rawContent}
                        </div>
                    </div>
                </div>
            );
        }

        function InteractionForm({ interaction, onSubmit, disabled }) {
            const [response, setResponse] = useState("");
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!response.trim() || submitting) return;
                setSubmitting(true);
                try {
                    await onSubmit(interaction.slug, interaction.targetKey, response.trim());
                    setResponse("");
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <section className="hairline rounded-2xl overflow-hidden io-in">
                    <div className="rtl-safe px-6 py-5 divider flex items-center justify-between">
                        <div className="min-w-0">
                            <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                INPUT REQUIRED
                            </div>
                            <div className="mt-2 text-[13px] leading-relaxed markdown-body">
                                {interaction.question || "Please provide your input."}
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {disabled && <span className="kbd" title="CLI offline">OFFLINE</span>}
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="px-6 py-5">
                        <textarea
                            value={response}
                            onChange={(e) => setResponse(e.target.value)}
                            disabled={disabled || submitting}
                            placeholder="Type response…"
                            className="w-full rounded-2xl hairline p-4 text-[13px] leading-relaxed min-h-[120px]"
                            style={{
                                background: "transparent",
                                color: "var(--fg)",
                                borderColor: "var(--hairline)",
                                outline: "none",
                                resize: "vertical",
                                direction: "ltr",
                                textAlign: "left",
                            }}
                        />
                        <div className="mt-4 flex items-center justify-between gap-3 rtl-safe">
                            <div className="text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                {submitting ? "SENDING…" : " "}
                            </div>
                            <button
                                type="submit"
                                disabled={disabled || submitting || !response.trim()}
                                className="px-4 py-2 rounded-xl hairline hover:hairline-strong transition disabled:opacity-40 disabled:cursor-not-allowed"
                                style={{ background: "transparent", color: "var(--fg)" }}
                            >
                                <span className="text-[11px] tracking-[0.18em] font-semibold">SUBMIT</span>
                            </button>
                        </div>
                    </form>
                </section>
            );
        }

        function App() {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [status, setStatus] = useState("connecting");
            const [workflowName, setWorkflowName] = useState(window.WORKFLOW_NAME_TEMPLATE || "");
            const [theme, setTheme] = useState(() => {
                const saved = localStorage.getItem("rf_theme");
                if (saved === "light" || saved === "dark") return saved;
                return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
            });
            const [pendingInteraction, setPendingInteraction] = useState(null);

            const token =
                window.SESSION_TOKEN && window.SESSION_TOKEN !== "{{" + "SESSION_TOKEN" + "}}" ? window.SESSION_TOKEN : null;

            const historyUrl = token ? `/api/history/${token}` : "/api/history";
            const eventsUrl = token ? `/api/events/${token}` : "/api/events";
            const submitUrl = token ? `/api/submit/${token}` : "/api/submit";

            useEffect(() => localStorage.setItem("rf_theme", theme), [theme]);

            useEffect(() => {
                if (history.length === 0) { setPendingInteraction(null); return; }

                const resolvedSlugs = new Set();
                let pending = null;

                for (const entry of history) {
                    const isResolution =
                        entry.event === "INTERACTION_RESOLVED" ||
                        entry.event === "PROMPT_ANSWERED" ||
                        entry.event === "INTERACTION_SUBMITTED";
                    const isRequest = entry.event === "INTERACTION_REQUESTED" || entry.event === "PROMPT_REQUESTED";

                    if (isResolution && entry.slug) resolvedSlugs.add(entry.slug);

                    if (isRequest && entry.slug && !resolvedSlugs.has(entry.slug) && !pending) {
                        pending = {
                            slug: entry.slug,
                            targetKey: entry.targetKey || `_interaction_${entry.slug}`,
                            question: entry.question,
                        };
                    }
                }

                setPendingInteraction(pending);
            }, [history]);

            const fetchData = async () => {
                try {
                    const res = await fetch(historyUrl);
                    const data = await res.json();
                    if (data.entries) setHistory(data.entries);
                    if (data.workflowName) setWorkflowName(data.workflowName);

                    if (token && data.cliConnected !== undefined) setStatus(data.cliConnected ? "connected" : "disconnected");
                    else if (!token) setStatus("connected");

                    setLoading(false);
                    return true;
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                    return false;
                }
            };

            useEffect(() => {
                fetchData();

                let eventSource = null;
                let reconnectTimeout = null;
                let pollInterval = null;
                let reconnectAttempts = 0;

                const connect = () => {
                    if (eventSource) eventSource.close();
                    eventSource = new EventSource(eventsUrl);

                    eventSource.onopen = () => {
                        setStatus("connected");
                        reconnectAttempts = 0;
                        fetchData();
                    };

                    eventSource.onerror = () => {
                        setStatus("disconnected");
                        eventSource.close();
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                        reconnectAttempts++;
                        reconnectTimeout = setTimeout(connect, delay);
                    };

                    eventSource.onmessage = (e) => {
                        try {
                            if (e.data === "update") { fetchData(); return; }
                            const data = JSON.parse(e.data);
                            switch (data.type) {
                                case "status":
                                    setStatus(data.cliConnected ? "connected" : "disconnected");
                                    if (data.workflowName) setWorkflowName(data.workflowName);
                                    break;
                                case "history":
                                    setHistory(data.entries || []);
                                    break;
                                case "event":
                                    setHistory((prev) => {
                                        if (data.event === "INTERACTION_SUBMITTED" && data.slug) {
                                            const hasDupe = prev.some((e) => e.event === "INTERACTION_SUBMITTED" && e.slug === data.slug);
                                            if (hasDupe) return prev;
                                        }
                                        return [data, ...prev];
                                    });
                                    break;
                                case "cli_connected":
                                case "cli_reconnected":
                                    setStatus("connected");
                                    break;
                                case "cli_disconnected":
                                    setStatus("disconnected");
                                    break;
                            }
                        } catch (err) { }
                    };
                };

                connect();
                pollInterval = setInterval(fetchData, 10000);

                return () => {
                    if (eventSource) eventSource.close();
                    if (reconnectTimeout) clearTimeout(reconnectTimeout);
                    if (pollInterval) clearInterval(pollInterval);
                };
            }, []);

            const handleSubmit = async (slug, targetKey, response) => {
                const optimisticEvent = {
                    timestamp: new Date().toISOString(),
                    event: "INTERACTION_SUBMITTED",
                    slug,
                    targetKey,
                    answer: response.substring(0, 200) + (response.length > 200 ? "..." : ""),
                    source: "remote",
                };
                setHistory((prev) => [optimisticEvent, ...prev]);

                try {
                    const res = await fetch(submitUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ slug, targetKey, response }),
                    });

                    if (!res.ok) {
                        setHistory((prev) => prev.filter((e) => e !== optimisticEvent));
                        const err = await res.json();
                        throw new Error(err.error || "Failed to submit");
                    }

                    setTimeout(fetchData, 1000);
                } catch (err) {
                    setHistory((prev) => prev.filter((e) => e !== optimisticEvent));
                    alert(err.message);
                }
            };

            const toggleTheme = () => setTheme((p) => (p === "dark" ? "light" : "dark"));

            const formatTime = (ts) =>
                new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });

            const visibleEvents = [...history].reverse();

            const wrapIO = (side, children, key) => (
                <div key={key} className={`io-row ${side === "right" ? "io-right" : side === "center" ? "io-center" : "io-left"}`}>
                    <div className="io-card">{children}</div>
                </div>
            );

            const renderPromptInputCard = (prompt, key) =>
                wrapIO(
                    "left",
                    <section className="hairline rounded-2xl rounded-tl-none overflow-hidden io-in">
                        <div className="rtl-safe px-5 py-4 divider flex items-center justify-between">
                            <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                PROMPT / INPUT
                            </div>
                            <CopyButton text={prompt} />
                        </div>
                        <div className="px-5 py-4">
                            <div className="markdown-body text-[13px] leading-relaxed overflow-x-auto">{prompt}</div>
                        </div>
                    </section>,
                    key
                );

            const renderEvent = (item, idx) => {
                const time = formatTime(item.timestamp);

                if (item.event && item.event.startsWith("WORKFLOW_")) {
                    return wrapIO(
                        "center",
                        <section className="text-center">
                            <div className="py-4">
                                <div className="text-[11px] tracking-[0.24em] font-semibold" style={{ color: "var(--muted)" }}>
                                    {item.event.replace("WORKFLOW_", "")} • {time}
                                </div>
                                {item.error && <div className="mt-3 text-[13px] leading-relaxed markdown-body">{item.error}</div>}
                            </div>
                        </section>,
                        idx
                    );
                }

                // CENTERED inside card
                if (item.event === "AGENT_STARTED") {
                    if (item.prompt) {
                        return wrapIO(
                            "left",
                            <section className="hairline rounded-2xl rounded-tl-none overflow-hidden io-in">
                                <details className="agent-prompt">
                                    <summary className="rtl-safe px-5 py-4 divider cursor-pointer">
                                        <div className="flex items-center justify-between gap-4">
                                            <div>
                                                <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                                    AGENT STARTED
                                                </div>
                                                <div className="mt-1 text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                                    {(item.agent || "").toString()} • {time}
                                                </div>
                                            </div>
                                            <CopyButton text={item.prompt} />
                                        </div>
                                        <div className="mt-3 text-[11px] tracking-[0.18em] font-semibold uppercase" style={{ color: "var(--muted)" }}>
                                            Show Prompt ▼
                                        </div>
                                    </summary>
                                    <div className="px-5 py-4">
                                        <div className="markdown-body text-[13px] leading-relaxed overflow-x-auto">{item.prompt}</div>
                                    </div>
                                </details>
                            </section>,
                            idx
                        );
                    }

                    return wrapIO(
                        "left",
                        <section className="hairline rounded-2xl rounded-tl-none px-6 py-5 io-in">
                            <div className="rtl-safe flex items-center justify-between gap-4">
                                <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                    AGENT STARTED
                                </div>
                                <span className="text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                    {time}
                                </span>
                            </div>
                            <div className="mt-3 text-[13px] leading-relaxed">
                                <span className="font-semibold">{item.agent}</span>
                            </div>
                        </section>,
                        idx
                    );
                }

                if (item.event === "AGENT_RESUMED") {
                    return wrapIO(
                        "center",
                        <section className="meta-center">
                            <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                AGENT RESUMED
                            </div>
                            <div className="mt-2 text-[13px] leading-relaxed">
                                <span className="font-semibold">{item.agent}</span>
                            </div>
                            <div className="mt-1 text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                {time}
                            </div>
                        </section>,
                        idx
                    );
                }

                if (item.event === "AGENT_FAILED") {
                    return wrapIO(
                        "center",
                        <section className="hairline rounded-2xl overflow-hidden">
                            <div className="rtl-safe px-5 py-4 divider flex items-center justify-between">
                                <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                    AGENT FAILED
                                </div>
                                <span className="text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                    {time}
                                </span>
                            </div>
                            <div className="px-5 py-4 meta-center">
                                <div className="text-[13px] leading-relaxed"><span className="font-semibold">{item.agent}</span></div>
                                <div className="mt-3 text-[13px] leading-relaxed markdown-body">{item.error}</div>
                            </div>
                        </section>,
                        idx
                    );
                }

                if (item.event === "INTERACTION_REQUESTED" || item.event === "PROMPT_REQUESTED") {
                    return wrapIO(
                        "center",
                        <section className="hairline rounded-2xl px-6 py-5">
                            <div className="rtl-safe flex items-center justify-between gap-4">
                                <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                    INTERVENTION REQUIRED
                                </div>
                                <span className="text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                    {time}
                                </span>
                            </div>
                            <div className="mt-3 text-[13px] leading-relaxed markdown-body">
                                {item.question ? `"${item.question}"` : `Waiting for response to "${item.slug}"…`}
                            </div>
                        </section>,
                        idx
                    );
                }

                if (item.event === "PROMPT_ANSWERED" || item.event === "INTERACTION_SUBMITTED") {
                    const isManual = item.source === "remote";
                    return wrapIO(
                        "center",
                        <section className="hairline rounded-2xl px-6 py-5">
                            <div className="rtl-safe flex items-center justify-between gap-4">
                                <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                    {isManual ? "RESOLVED VIA BROWSER" : "USER ANSWERED"}
                                </div>
                                <span className="text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                    {time}
                                </span>
                            </div>
                            <div className="mt-3 text-[13px] leading-relaxed markdown-body">"{item.answer}"</div>
                        </section>,
                        idx
                    );
                }

                if (item.event === "AGENT_COMPLETED" || item.event === "INTERACTION_RESOLVED") {
                    if (item.event === "AGENT_COMPLETED") {
                        return wrapIO(
                            "right",
                            <section className="io-out">
                                <section className="meta-center mb-4">
                                    <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                        DONE
                                    </div>
                                    <div className="mt-1 text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                        {(item.agent || "").toString()} • {time}
                                    </div>
                                </section>
                                {(item.output || item.result) && (
                                    <JsonView data={item.output || item.result} label="OUTPUT / RESPONSE" align="right" />
                                )}
                            </section>,
                            idx
                        );
                    }

                    return wrapIO(
                        "center",
                        <section className="meta-center">
                            <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                DONE
                            </div>
                            <div className="mt-1 text-[11px] tracking-[0.14em]" style={{ color: "var(--muted)" }}>
                                {(item.slug || "").toString()} • {time}
                            </div>
                        </section>,
                        idx
                    );
                }

                const stripped = JSON.parse(
                    JSON.stringify(item, (key, value) => {
                        if (key === "event" || key === "timestamp") return undefined;
                        return value;
                    })
                );

                if (item.prompt) {
                    return (
                        <React.Fragment key={idx}>
                            {wrapIO(
                                "center",
                                <section>
                                    <JsonView
                                        data={stripped}
                                        label={(item.event || "EVENT").toString()}
                                        timestamp={time}
                                        align="left"
                                    />
                                </section>,
                                `evt-${idx}`
                            )}
                            {renderPromptInputCard(item.prompt, `prompt-${idx}`)}
                        </React.Fragment>
                    );
                }

                return wrapIO(
                    "center",
                    <section>
                        <JsonView
                            data={stripped}
                            label={(item.event || "EVENT").toString()}
                            timestamp={time}
                            align="left"
                        />
                    </section>,
                    idx
                );
            };

            if (loading && !history.length) {
                return (
                    <div className={theme}>
                        <div className="min-h-screen flex items-center justify-center">
                            <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                OPENING TERMINAL<span className="blink">…</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={theme}>
                    <div className="min-h-screen" style={{ background: "var(--bg)", color: "var(--fg)" }}>
                        <div className="edge-wrap">
                            {/* Header (centered) */}
                            <header className="sticky top-0 z-50 py-4" style={{ background: "var(--bg)" }}>
                                <div className="center-wrap">
                                    <div className="divider" style={{ marginBottom: 14 }} />

                                    <div className="flex items-center justify-between gap-4">
                                        <div className="min-w-0 flex items-center gap-3">
                                            <div className="text-[12px] tracking-[0.24em] font-semibold uppercase whitespace-nowrap" style={{ color: "var(--muted)" }}>
                                                {workflowName || "WORKFLOW"}
                                            </div>

                                            <StatusBadge status={status} />
                                        </div>

                                        <div className="flex items-center gap-2">
                                            <Toggle onClick={() => setTheme((p) => (p === "dark" ? "light" : "dark"))} label="" title="Toggle theme">
                                                {theme === "dark" ? <Icon name="sun" /> : <Icon name="moon" />}
                                            </Toggle>
                                        </div>
                                    </div>

                                    <div className="divider" style={{ marginTop: 14 }} />
                                </div>
                            </header>

                            {/* Error stays right */}
                            {error && (
                                <div className="io-row io-right mb-8">
                                    <div className="io-card">
                                        <div className="hairline rounded-2xl px-5 py-4 io-out meta-center">
                                            <div className="text-[11px] tracking-[0.22em] font-semibold" style={{ color: "var(--muted)" }}>
                                                ERROR
                                            </div>
                                            <div className="mt-2 text-[13px] leading-relaxed markdown-body">{String(error)}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <main className="space-y-10">
                                {visibleEvents.length === 0 && (
                                    <div className="center-wrap py-16 text-center">
                                        <div className="text-[11px] tracking-[0.28em] font-semibold" style={{ color: "var(--muted)" }}>
                                            WAITING FOR EVENTS<span className="blink">…</span>
                                        </div>
                                    </div>
                                )}

                                {visibleEvents.map(renderEvent)}
                            </main>

                            {pendingInteraction && (
                                <div className="io-row io-left mt-10">
                                    <div className="io-card">
                                        <InteractionForm
                                            interaction={pendingInteraction}
                                            onSubmit={handleSubmit}
                                            disabled={status !== "connected"}
                                        />
                                    </div>
                                </div>
                            )}

                            <footer className="mt-16 pt-8 divider">
                                <div className="center-wrap text-center">
                                    <div className="py-6 text-[11px] tracking-[0.28em] font-semibold" style={{ color: "var(--muted)" }}>
                                        SUPAMACHINE • TERMINAL v1.4
                                    </div>
                                </div>
                            </footer>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>